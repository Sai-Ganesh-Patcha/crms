<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Change Password - CRMS</title>
    <link rel="stylesheet" href="../css/main.css">
</head>

<body>
    <div class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1>üîê Change Password</h1>
                <p>Update your account password</p>
            </div>
            <div class="login-body">
                <div id="alertBox" class="alert" style="display:none"></div>
                <form id="changeForm">
                    <div class="form-group">
                        <label class="form-label">Current Password</label>
                        <input type="password" id="currentPassword" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">New Password</label>
                        <input type="password" id="newPassword" class="form-control" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm New Password</label>
                        <input type="password" id="confirmPassword" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width:100%">Update Password</button>
                </form>
            </div>
            <div class="login-footer">
                <a href="javascript:history.back()" class="btn btn-secondary">‚Üê Back to Dashboard</a>
            </div>
        </div>
    </div>

    <script src="../js/students1.js"></script>
    <script src="../js/students2.js"></script>
    <script src="../js/data.js"></script>
    <script src="../js/security.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        if (!Auth.isLoggedIn()) { window.location.href = 'login.html'; }

        // Check if this is a first-login password change
        const isFirstLogin = sessionStorage.getItem('requiresPasswordChange') === 'true';
        const user = Auth.getCurrentUser();

        // Update the header if this is first login
        if (isFirstLogin) {
            document.querySelector('.login-header h1').innerHTML = 'üîê Set Your Password';
            document.querySelector('.login-header p').textContent = 'For security, please change your default password';
            document.querySelector('.login-footer').style.display = 'none'; // Hide back button for first login
        }

        function showAlert(msg, type) {
            const box = document.getElementById('alertBox');
            box.className = 'alert alert-' + type;
            box.innerHTML = msg;
            box.style.display = 'flex';
        }

        // Get redirect URL based on user role
        function getRedirectUrl() {
            if (!user) return 'login.html';
            switch (user.role) {
                case 'student': return 'student.html';
                case 'faculty': return 'faculty.html';
                case 'hod': return 'hod.html';
                case 'admin': return 'admin.html';
                default: return 'login.html';
            }
        }

        document.getElementById('changeForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const current = document.getElementById('currentPassword').value;
            const newPass = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmPassword').value;

            if (newPass !== confirm) {
                showAlert('New passwords do not match!', 'danger');
                return;
            }

            if (newPass.length < 6) {
                showAlert('Password must be at least 6 characters long!', 'danger');
                return;
            }

            const result = Auth.changePassword(current, newPass);

            if (result.success) {
                // Clear the first-login flag
                sessionStorage.removeItem('requiresPasswordChange');

                showAlert('Password changed successfully! Redirecting...', 'success');

                // Redirect appropriately
                if (isFirstLogin) {
                    setTimeout(() => window.location.href = getRedirectUrl(), 1500);
                } else {
                    setTimeout(() => history.back(), 1500);
                }
            } else {
                showAlert(result.error, 'danger');
            }
        });
    </script>
</body>

</html>