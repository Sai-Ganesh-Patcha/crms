<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faculty Dashboard - CRMS</title>
    <link rel="stylesheet" href="../css/main.css">
</head>

<body>
    <nav class="navbar">
        <div class="navbar-brand">üéì CRMS - Faculty Portal</div>
        <div class="nav-user">
            <span id="userName">Faculty</span>
            <a href="change-password.html" class="btn btn-sm btn-secondary">Change Password</a>
            <button class="btn btn-sm btn-danger" onclick="Auth.logout()">Logout</button>
        </div>
    </nav>

    <div class="main-content full-width">
        <div class="page-header">
            <h1>Faculty Dashboard</h1>
            <p>Welcome back! View student performance and analytics</p>
        </div>

        <!-- Stats Cards -->
        <div class="dashboard-grid" id="statsGrid"></div>

        <!-- Quick Actions -->
        <div class="grid-4 mb-3">
            <div class="card" style="cursor:pointer" onclick="showSection('all-students')">
                <div class="card-body text-center">
                    <div style="font-size:2.5rem;margin-bottom:0.5rem">üë•</div>
                    <h4>All Students</h4>
                    <p class="text-muted" style="margin:0">View all student details</p>
                </div>
            </div>
            <div class="card" style="cursor:pointer" onclick="showSection('toppers')">
                <div class="card-body text-center">
                    <div style="font-size:2.5rem;margin-bottom:0.5rem">üèÜ</div>
                    <h4>Top 20 Students</h4>
                    <p class="text-muted" style="margin:0">Best performers</p>
                </div>
            </div>
            <div class="card" style="cursor:pointer" onclick="showSection('poor')">
                <div class="card-body text-center">
                    <div style="font-size:2.5rem;margin-bottom:0.5rem">üìâ</div>
                    <h4>Bottom 10</h4>
                    <p class="text-muted" style="margin:0">Need attention</p>
                </div>
            </div>
            <div class="card" style="cursor:pointer" onclick="showSection('backlogs')">
                <div class="card-body text-center">
                    <div style="font-size:2.5rem;margin-bottom:0.5rem">üìã</div>
                    <h4>Backlogs</h4>
                    <p class="text-muted" style="margin:0">Subject & student wise</p>
                </div>
            </div>
        </div>

        <!-- Content Sections -->
        <div id="all-students" class="section" style="display:none">
            <div class="table-container">
                <div class="table-header">
                    <h3>All Students</h3>
                    <div class="search-box">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="11" cy="11" r="8" />
                            <path d="m21 21-4.35-4.35" />
                        </svg>
                        <input type="text" id="searchInput" placeholder="Search by name or regno..."
                            oninput="filterStudents()">
                    </div>
                </div>
                <div style="overflow-x:auto">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Regd. No</th>
                                <th>Name</th>
                                <th>Gender</th>
                                <th>CGPA</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="allStudentsTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="toppers" class="section" style="display:none">
            <div class="table-container">
                <div class="table-header">
                    <h3>üèÜ Top 20 Students (by CGPA)</h3>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Regd. No</th>
                            <th>Name</th>
                            <th>CGPA</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="toppersTable"></tbody>
                </table>
            </div>
        </div>

        <div id="poor" class="section" style="display:none">
            <div class="table-container">
                <div class="table-header">
                    <h3>üìâ Bottom 10 Students (Need Attention)</h3>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Regd. No</th>
                            <th>Name</th>
                            <th>CGPA</th>
                            <th>Backlogs</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="poorTable"></tbody>
                </table>
            </div>
        </div>

        <div id="backlogs" class="section" style="display:none">
            <div class="tabs">
                <div class="tab active" onclick="showBacklogTab('subject')">By Subject</div>
                <div class="tab" onclick="showBacklogTab('student')">By Student</div>
            </div>
            <div id="backlog-subject" class="backlog-content">
                <div class="table-container">
                    <div class="table-header">
                        <h3>Subject-wise Backlogs</h3>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Subject</th>
                                <th>Count</th>
                                <th>Students</th>
                            </tr>
                        </thead>
                        <tbody id="subjectBacklogTable"></tbody>
                    </table>
                </div>
            </div>
            <div id="backlog-student" class="backlog-content" style="display:none">
                <div class="form-group" style="max-width:400px">
                    <label class="form-label">Enter Registration Number</label>
                    <input type="text" id="backlogRegno" class="form-control" placeholder="e.g., 23K61A4401">
                    <button class="btn btn-primary mt-1" onclick="searchStudentBacklogs()">Search</button>
                </div>
                <div id="studentBacklogResult"></div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="app-footer no-print">
        <div class="footer-content">
            <div class="footer-left">üéì College Result Management System</div>
            <div class="footer-right">Department of Computer Science & Data Science | v2.0</div>
        </div>
    </footer>

    <!-- Student View Modal -->
    <div class="modal-overlay" id="studentModal">
        <div class="modal" style="max-width:800px">
            <div class="modal-header">
                <h3>Student Details</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="studentModalContent"></div>
        </div>
    </div>

    <script src="../js/students1.js"></script>
    <script src="../js/students2.js"></script>
    <script src="../js/data.js"></script>
    <script src="../js/security.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/ui.js"></script>
    <script>
        if (!Auth.requireAuth(['faculty', 'hod', 'admin'])) { throw new Error('Access denied'); }
        initializeData();

        const user = Auth.getCurrentUser();
        document.getElementById('userName').textContent = user.name;

        const students = getStudents().filter(s => s.name && s.name !== 'NaN');
        const stats = getDepartmentStats();

        // Populate stats
        document.getElementById('statsGrid').innerHTML = `
            <div class="stat-card"><div class="stat-icon primary">üë•</div><div class="stat-content"><h3>${stats.total}</h3><p>Total Students</p></div></div>
            <div class="stat-card"><div class="stat-icon success">üåü</div><div class="stat-content"><h3>${stats.excellent + stats.best}</h3><p>Excellent/Best (‚â•8)</p></div></div>
            <div class="stat-card"><div class="stat-icon warning">üìä</div><div class="stat-content"><h3>${stats.good + stats.average}</h3><p>Good/Average (6-8)</p></div></div>
            <div class="stat-card"><div class="stat-icon danger">‚ö†Ô∏è</div><div class="stat-content"><h3>${stats.withBacklogs}</h3><p>With Backlogs</p></div></div>
        `;

        let allStudentsData = students.map(s => ({ ...s, cgpa: parseFloat(calculateCGPA(s)) }));

        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            if (id === 'all-students') loadAllStudents();
            else if (id === 'toppers') loadToppers();
            else if (id === 'poor') loadPoor();
            else if (id === 'backlogs') loadBacklogs();
        }

        function loadAllStudents() {
            renderStudentTable(allStudentsData, 'allStudentsTable');
        }

        function filterStudents() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allStudentsData.filter(s => s.name.toLowerCase().includes(query) || s.regno.toLowerCase().includes(query));
            renderStudentTable(filtered, 'allStudentsTable');
        }

        function renderStudentTable(data, tableId) {
            const tbody = document.getElementById(tableId);
            tbody.innerHTML = data.map(s => {
                const perf = getPerformanceStatus(s.cgpa);
                return `<tr>
                    <td>${s.regno}</td>
                    <td>${s.name}</td>
                    <td>${s.gender}</td>
                    <td><strong>${s.cgpa.toFixed(2)}</strong></td>
                    <td><span class="badge ${perf.class}" style="background:none">${perf.text}</span></td>
                    <td><button class="btn btn-sm btn-primary" onclick="viewStudent('${s.regno}')">View</button></td>
                </tr>`;
            }).join('');
        }

        function loadToppers() {
            const toppers = getToppers();
            document.getElementById('toppersTable').innerHTML = toppers.map((s, i) => `
                <tr>
                    <td><span class="badge badge-success">#${i + 1}</span></td>
                    <td>${s.regno}</td>
                    <td>${s.name}</td>
                    <td><strong>${s.cgpa.toFixed(2)}</strong></td>
                    <td><button class="btn btn-sm btn-primary" onclick="viewStudent('${s.regno}')">View</button></td>
                </tr>
            `).join('');
        }

        function loadPoor() {
            const poor = getPoorPerformers();
            document.getElementById('poorTable').innerHTML = poor.map(s => {
                const backlogs = getBacklogsByStudent(s.regno);
                return `<tr>
                    <td>${s.regno}</td>
                    <td>${s.name}</td>
                    <td><strong class="text-danger">${s.cgpa.toFixed(2)}</strong></td>
                    <td><span class="badge badge-danger">${backlogs.length} subjects</span></td>
                    <td><button class="btn btn-sm btn-primary" onclick="viewStudent('${s.regno}')">View</button></td>
                </tr>`;
            }).join('');
        }

        function loadBacklogs() {
            const backlogs = getBacklogsBySubject();
            document.getElementById('subjectBacklogTable').innerHTML = Object.entries(backlogs).map(([subj, regnos]) => `
                <tr>
                    <td><strong>${CRMS_DATA.subjectNames[subj] || subj}</strong></td>
                    <td><span class="badge badge-danger">${regnos.length}</span></td>
                    <td style="font-size:0.875rem">${regnos.join(', ')}</td>
                </tr>
            `).join('') || '<tr><td colspan="3" class="text-center text-muted">No backlogs found</td></tr>';
        }

        function showBacklogTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.backlog-content').forEach(c => c.style.display = 'none');
            document.getElementById('backlog-' + tab).style.display = 'block';
        }

        function searchStudentBacklogs() {
            const regno = document.getElementById('backlogRegno').value.trim();
            const backlogs = getBacklogsByStudent(regno);
            const student = getStudentByRegno(regno);

            if (!student) {
                document.getElementById('studentBacklogResult').innerHTML = '<div class="alert alert-danger">Student not found</div>';
                return;
            }

            if (backlogs.length === 0) {
                document.getElementById('studentBacklogResult').innerHTML = `<div class="alert alert-success">${student.name} has no backlogs!</div>`;
                return;
            }

            document.getElementById('studentBacklogResult').innerHTML = `
                <div class="card mt-2">
                    <div class="card-header"><h4>${student.name} (${regno})</h4></div>
                    <div class="card-body">
                        <p><strong>Total Backlogs:</strong> <span class="badge badge-danger">${backlogs.length}</span></p>
                        <table class="table">
                            <thead><tr><th>Semester</th><th>Subject</th></tr></thead>
                            <tbody>${backlogs.map(b => `<tr><td>${b.semester.toUpperCase()}</td><td>${CRMS_DATA.subjectNames[b.subject] || b.subject}</td></tr>`).join('')}</tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function viewStudent(regno) {
            const student = getStudentByRegno(regno);
            const cgpa = parseFloat(calculateCGPA(student));
            const perf = getPerformanceStatus(cgpa);

            let html = `
                <div class="flex gap-2 mb-2">
                    <div class="faculty-avatar" style="width:60px;height:60px">${student.name.charAt(0)}</div>
                    <div>
                        <h3 style="margin:0">${student.name}</h3>
                        <p class="text-muted" style="margin:0">${student.regno} ‚Ä¢ ${student.gender === 'F' ? 'Female' : 'Male'}</p>
                        <span class="performance-badge ${perf.class}" style="margin-top:0.5rem;display:inline-block">CGPA: ${cgpa.toFixed(2)} - ${perf.text}</span>
                    </div>
                </div>
                <hr style="margin:1rem 0">
                <h4>Semester Results</h4>
                <p class="text-muted" style="font-size:0.875rem">Click on a semester to view subject details</p>`;

            const semNames = { sem1: 'Semester 1', sem2: 'Semester 2', sem3: 'Semester 3', sem4: 'Semester 4', sem5: 'Semester 5', sem6: 'Semester 6', sem7: 'Semester 7', sem8: 'Semester 8' };

            Object.entries(student.semesters || {}).forEach(([key, sem]) => {
                const semId = `sem-details-${key}`;
                let subjectRows = '';
                Object.entries(sem.subjects || {}).forEach(([subj, grade]) => {
                    const gradeClass = grade === 'F' ? 'danger' : (grade === 'S' || grade === 'A' ? 'success' : 'primary');
                    subjectRows += `<tr>
                        <td>${CRMS_DATA.subjectNames[subj] || subj}</td>
                        <td class="text-center"><span class="badge badge-${gradeClass}">${grade}</span></td>
                    </tr>`;
                });

                html += `<div class="card mb-1" style="cursor:pointer" onclick="toggleSemesterDetails('${semId}', this)">
                    <div class="card-body" style="display:flex;justify-content:space-between;align-items:center">
                        <div>
                            <strong>${semNames[key] || key}</strong> - 
                            <span class="badge badge-${sem.status === 'PASS' ? 'success' : 'danger'}">${sem.status}</span>
                            &nbsp; SGPA: <strong>${sem.sgpa && !isNaN(sem.sgpa) ? sem.sgpa.toFixed(2) : 'N/A'}</strong>
                        </div>
                        <span class="expand-icon" style="font-size:1.2rem;transition:transform 0.2s">‚ñ∂</span>
                    </div>
                    <div id="${semId}" class="sem-details" style="display:none;padding:0 1rem 1rem;border-top:1px solid #e2e8f0">
                        <table class="table" style="margin-top:0.75rem">
                            <thead><tr><th>Subject</th><th class="text-center">Grade</th></tr></thead>
                            <tbody>${subjectRows || '<tr><td colspan="2" class="text-center text-muted">No subjects found</td></tr>'}</tbody>
                        </table>
                    </div>
                </div>`;
            });

            document.getElementById('studentModalContent').innerHTML = html;
            document.getElementById('studentModal').classList.add('active');
        }

        function toggleSemesterDetails(id, cardEl) {
            event.stopPropagation();
            const details = document.getElementById(id);
            const icon = cardEl.querySelector('.expand-icon');
            if (details.style.display === 'none') {
                details.style.display = 'block';
                icon.style.transform = 'rotate(90deg)';
            } else {
                details.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        function closeModal() {
            document.getElementById('studentModal').classList.remove('active');
        }

        document.getElementById('studentModal').addEventListener('click', function (e) {
            if (e.target === this) closeModal();
        });

        // Show all students by default
        showSection('all-students');
    </script>
</body>

</html>